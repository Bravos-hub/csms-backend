generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  EVZONE_ADMIN
  EVZONE_OPERATOR
  SITE_OWNER
  STATION_OWNER
  OWNER
  STATION_OPERATOR
  STATION_ADMIN
  MANAGER
  ATTENDANT
  CASHIER
  TECHNICIAN_ORG
  TECHNICIAN_PUBLIC
  DRIVER
}

enum StationType {
  CHARGING
  SWAPPING
}

enum StationOwnerCapability {
  CHARGE
  SWAP
  BOTH
}

model User {
  id              String  @id @default(uuid())
  name            String
  email           String? @unique
  phone           String? @unique
  passwordHash    String?
  role            UserRole                @default(SITE_OWNER)
  status          String                  @default("Pending")
  ownerCapability StationOwnerCapability? // Only for STATION_OWNER

  // Registration & Onboarding Fields
  country           String?
  region            String?
  subscribedPackage String? // Free, Starter, Growth, Pro, Enterprise
  organizationId    String?

  // Relations
  organization         Organization?       @relation(fields: [organizationId], references: [id])
  applications         TenantApplication[] @relation("Applications")
  reviewedApplications TenantApplication[] @relation("ReviewedApplications")

  // OTP
  otpCode      String?
  otpExpiresAt DateTime?

  // Email Verification
  emailVerifiedAt         DateTime?
  emailVerificationTokens EmailVerificationToken[]

  // Relations
  wallet           Wallet?
  invoices         Invoice[]
  bookings         Booking[]
  sites            Site[]
  ownedStations    Station[] @relation("StationOwner")
  operatedStations Station[] @relation("StationOperator")

  // Document Relations
  uploadedDocuments  Document[] @relation("UploadedDocuments")
  verifiedDocuments  Document[] @relation("VerifiedDocuments")
  
  // Negotiation Relations
  proposedNegotiations  NegotiationRound[] @relation("ProposedNegotiations")
  respondedNegotiations NegotiationRound[] @relation("RespondedNegotiations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  description String?
  logoUrl     String?
  type        String   @default("COMPANY") // COMPANY, INDIVIDUAL
  
  // Financials
  paymentProvider String?  // MTN, AIRTEL, M-PESA
  walletNumber    String?
  taxId           String?
  regId           String?
  
  // Address
  address         String?
  city            String?
  
  users       User[]
  sites       Site[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("organizations")
}

model Station {
  id        String  @id @default(uuid())
  name      String
  status    String  @default("ACTIVE")
  latitude  Float
  longitude Float
  address   String
  type        StationType @default(CHARGING)
  ownerId     String?
  operatorId  String?
  siteId      String?

  // Relations
  owner        User?         @relation("StationOwner", fields: [ownerId], references: [id])
  operator     User?         @relation("StationOperator", fields: [operatorId], references: [id])
  site         Site?         @relation(fields: [siteId], references: [id])
  chargePoints ChargePoint[]
  incidents    Incident[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stations")
}

model ChargePoint {
  id              String  @id @default(uuid())
  stationId       String
  ocppId          String  @unique
  status          String  @default("AVAILABLE")
  model           String?
  vendor          String?
  firmwareVersion String?

  // Auth for OCPP Gateway
  clientSecretHash String?
  clientSecretSalt String?
  allowedInsecure  Boolean @default(false)

  station  Station   @relation(fields: [stationId], references: [id])
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("charge_points")
}

model Session {
  id          String  @id @default(uuid())
  stationId   String
  connectorId Int
  ocppTxId    String? @unique
  ocppId      String
  idTag       String?
  userId      String?

  startTime   DateTime
  endTime     DateTime?
  meterStart  Float     @default(0)
  meterStop   Float     @default(0)
  totalEnergy Float     @default(0)
  amount      Float     @default(0) // Revenue in USD
  status      String    @default("ACTIVE")

  chargePoint ChargePoint @relation(fields: [ocppId], references: [ocppId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sessions")
}

model Booking {
  id            String   @id @default(uuid())
  userId        String
  stationId     String
  chargePointId String?
  startTime     DateTime
  endTime       DateTime
  status        String   @default("PENDING")

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bookings")
}

model Wallet {
  id       String @id @default(uuid())
  userId   String @unique
  balance  Float  @default(0)
  currency String @default("USD")

  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("wallets")
}

model Transaction {
  id          String  @id @default(uuid())
  walletId    String
  amount      Float
  type        String
  description String?
  reference   String?

  wallet Wallet @relation(fields: [walletId], references: [id])

  createdAt DateTime @default(now())

  @@map("transactions")
}

model Invoice {
  id          String   @id @default(uuid())
  userId      String
  totalAmount Float
  status      String
  dueDate     DateTime

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoices")
}

model Incident {
  id            String  @id @default(uuid())
  stationId     String
  chargePointId String?
  title         String
  description   String
  severity      String
  status        String  @default("OPEN")
  assignedTo    String?

  station    Station    @relation(fields: [stationId], references: [id])
  dispatches Dispatch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("incidents")
}

model Dispatch {
  id           String    @id @default(uuid())
  incidentId   String
  technicianId String
  status       String    @default("PENDING")
  notes        String?
  scheduledAt  DateTime?

  incident Incident @relation(fields: [incidentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dispatches")
}

enum SitePurpose {
  PERSONAL
  COMMERCIAL
}

enum LeaseType {
  REVENUE_SHARE
  FIXED_RENT
  HYBRID
}

enum Footfall {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

model Site {
  id              String      @id @default(uuid())
  name            String
  city            String
  address         String
  powerCapacityKw Float
  parkingBays     Int
  purpose         SitePurpose @default(COMMERCIAL)
  latitude        Float?
  longitude       Float?
  photos          String      @default("[]") // JSON array of photo URLs
  amenities       String      @default("[]") // JSON array
  tags            String      @default("[]") // JSON array
  ownerId         String
  organizationId  String?

  // Relations
  owner              User                 @relation(fields: [ownerId], references: [id])
  organization       Organization?        @relation(fields: [organizationId], references: [id])
  stations           Station[]
  tenants            Tenant[]
  leaseDetails       SiteLeaseDetails?
  documents          SiteDocument[]
  tenantApplications TenantApplication[]

  // Document Verification
  documentsVerified   Boolean  @default(false)
  documentsVerifiedAt DateTime?
  documentsVerifiedBy String?
  
  // Status to include verification state
  verificationStatus String @default("PENDING") // PENDING, VERIFIED, REJECTED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sites")
}

model SiteLeaseDetails {
  id                   String    @id @default(uuid())
  siteId               String    @unique
  leaseType            LeaseType
  expectedMonthlyPrice Float?
  expectedFootfall     Footfall
  status               String    @default("PENDING")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_lease_details")
}

model Tenant {
  id        String    @id @default(uuid())
  name      String
  type      String
  status    String    @default("Active")
  siteId    String
  startDate DateTime?

  site Site @relation(fields: [siteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}


enum ApplicationStatus {
  DRAFT
  PENDING_REVIEW
  INFO_REQUESTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  
  NEGOTIATING
  TERMS_AGREED
  
  AWAITING_DEPOSIT
  DEPOSIT_PAID
  
  LEASE_DRAFTING
  LEASE_PENDING_SIGNATURE
  LEASE_SIGNED
  
  COMPLIANCE_CHECK
  COMPLETED
  
  WITHDRAWN
  CANCELLED
  EXPIRED
}

model TenantApplication {
  id          String  @id @default(uuid())
  applicantId String
  
  // Organization Details
  organizationName           String
  businessRegistrationNumber String
  taxComplianceNumber        String?

  // Contact Information
  contactPersonName String
  contactEmail      String
  contactPhone      String
  physicalAddress   String
  companyWebsite    String?

  // Business Experience
  yearsInEVBusiness        String // '<1', '1-3', '3-5', '5+'
  existingStationsOperated Int?

  // Site & Proposal
  siteId                     String
  preferredLeaseModel        String // 'Revenue Share' | 'Fixed Rent' | 'Hybrid'
  businessPlanSummary        String @db.Text
  sustainabilityCommitments  String? @db.Text
  additionalServices         String  @default("[]") // JSON array
  estimatedStartDate         String?

  // Commercial Terms (Set by Site Owner)
  proposedRent            Float?
  proposedTerm            Int? // months
  numberOfChargingPoints  Int?
  totalPowerRequirement   Float? // kW
  chargingTechnology      String @default("[]") // JSON array
  targetCustomerSegment   String @default("[]") // JSON array

  // Application Status
  status          ApplicationStatus    @default(DRAFT)
  message         String?   @db.Text // Initial application message
  
  // Review
  reviewedBy    String?
  reviewedAt    DateTime?
  approvalNotes String?   @db.Text
  
  // Response
  responseMessage String?   @db.Text // Site owner response
  respondedAt     DateTime?
  
  // Negotiation & Lease scalars (Relations to be added in future phases)
  proposedTerms     Json?
  negotiatedTerms   Json?
  termsAgreedAt     DateTime?
  securityDepositAmount Decimal?
  depositPaidAt         DateTime?
  depositReceiptUrl     String?
  paymentId             String?
  leaseAgreementUrl String?
  leaseSignedAt     DateTime?
  leaseStartDate    DateTime?
  leaseEndDate      DateTime?
  completedAt       DateTime?


  negotiationRounds NegotiationRound[]

  // Relations
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  applicant         User                 @relation("Applications", fields: [applicantId], references: [id])
  reviewer          User?                @relation("ReviewedApplications", fields: [reviewedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenant_applications")
}

model SiteDocument {
  id          String  @id @default(uuid())
  siteId      String
  name        String
  type        String // e.g., 'lease_agreement', 'permit', 'insurance', 'inspection_report'
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  uploadedBy  String?
  description String?

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_documents")
}

model Webhook {
  id     String  @id @default(uuid())
  url    String
  events String
  active Boolean @default(true)
  secret String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("webhooks")
}

enum DocumentCategory {
  // Site Owner Documents
  OWNERSHIP_PROOF
  OWNER_IDENTITY
  OWNER_ADDRESS_PROOF
  SITE_PHOTOS
  ELECTRICAL_CAPACITY
  SITE_PLAN
  LAND_USE_PERMIT
  SOCIETY_NOC
  LENDER_CONSENT
  CO_OWNER_CONSENT
  BUSINESS_REGISTRATION
  
  // Operator Documents
  OPERATOR_IDENTITY
  OPERATOR_ADDRESS_PROOF
  OPERATOR_PHOTO
  OPERATOR_BUSINESS_REG
  TAX_CERTIFICATE
  BANK_STATEMENTS
  INSTALLATION_LICENSE
  INSURANCE_CERTIFICATE
  PORTFOLIO
  INSTALLATION_PLAN
  EQUIPMENT_SPECS
  
  // Lease Documents
  LEASE_AGREEMENT
  LEASE_REGISTRATION
  STAMP_DUTY_RECEIPT
  SECURITY_DEPOSIT_RECEIPT
  INDEMNITY_BOND
  EXECUTED_LEASE
  
  OTHER
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
  INFO_REQUESTED
}

enum EntityType {
  SITE
  APPLICATION
  TENANT
  USER
}

model Document {
  id        String   @id @default(uuid())
  
  // Classification
  category    DocumentCategory
  entityType  EntityType
  entityId    String
  
  // File Information
  fileName           String
  fileUrl            String
  fileType           String
  fileSize           Int
  cloudinaryPublicId String
  
  // Metadata
  uploadedBy   String
  uploadedAt   DateTime @default(now())
  
  // Verification
  status           DocumentStatus @default(PENDING)
  verifiedBy       String?
  verifiedAt       DateTime?
  rejectionReason  String?        @db.Text
  
  // Expiry
  expiryDate       DateTime?
  expiryReminder   Boolean        @default(false)
  
  // Business Logic
  isRequired       Boolean        @default(false)
  allowMultiple    Boolean        @default(false)
  
  // Additional Context
  notes            String?        @db.Text
  metadata         Json?
  
  // Relations
  uploader User @relation("UploadedDocuments", fields: [uploadedBy], references: [id])
  verifier User? @relation("VerifiedDocuments", fields: [verifiedBy], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("documents")
  @@index([entityType, entityId])
  @@index([status])
  @@index([category])
}

model NegotiationRound {
  id            String   @id @default(uuid())
  applicationId String
  proposedBy    String   // userId (site owner or operator)
  
  // Lease Terms
  terms Json // { monthlyRent, currency, leaseDuration, revenueSharePercent, etc. }
  
  // Status
  status       String    @default("PROPOSED") // PROPOSED, COUNTERED, ACCEPTED, REJECTED
  respondedBy  String?
  respondedAt  DateTime?
  
  // Communication
  message String? @db.Text
  
  // Relations
  application TenantApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  proposer    User              @relation("ProposedNegotiations", fields: [proposedBy], references: [id])
  responder   User?             @relation("RespondedNegotiations", fields: [respondedBy], references: [id])
  
  createdAt DateTime @default(now())
  
  @@map("negotiation_rounds")
  @@index([applicationId])
}


model Command {
  id            String    @id @default(uuid())
  stationId     String?   @map("station_id")
  chargePointId String?   @map("charge_point_id")
  connectorId   String?   @map("connector_id")
  commandType   String    @map("command_type")
  payload       Json?
  status        String
  requestedBy   String?   @map("requested_by")
  requestedAt   DateTime  @map("requested_at")
  sentAt        DateTime? @map("sent_at")
  completedAt   DateTime? @map("completed_at")
  correlationId String?   @map("correlation_id")
  error         String?

  @@map("commands")
}

model CommandOutbox {
  id          String    @id @default(uuid())
  commandId   String    @map("command_id")
  status      String
  attempts    Int       @default(0)
  lockedAt    DateTime? @map("locked_at")
  publishedAt DateTime? @map("published_at")
  lastError   String?   @map("last_error")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("command_outbox")
}

model CommandEvent {
  id         String   @id @default(uuid())
  commandId  String   @map("command_id")
  status     String
  payload    Json?
  occurredAt DateTime @map("occurred_at")

  @@map("command_events")
}

model OcpiPartner {
  id          String    @id @default(uuid())
  name        String
  partyId     String    @db.VarChar(3) @map("party_id")
  countryCode String    @db.VarChar(2) @map("country_code")
  role        String
  status      String    @default("PENDING")
  version     String    @default("2.2.1")
  versionsUrl String?   @map("versions_url")
  tokenA      String?   @map("token_a")
  tokenB      String?   @map("token_b")
  tokenC      String?   @map("token_c")
  roles       Json?
  endpoints   Json?
  lastSyncAt  DateTime? @map("last_sync_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_partners")
  @@index([status])
  @@index([partyId, countryCode])
}

model OcpiPartnerLocation {
  id          String   @id @default(uuid())
  countryCode String   @db.VarChar(2) @map("country_code")
  partyId     String   @db.VarChar(3) @map("party_id")
  locationId  String   @map("location_id")
  version     String   @default("2.2.1")
  data        Json
  lastUpdated DateTime @map("last_updated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_partner_locations")
  @@unique([countryCode, partyId, locationId, version])
  @@index([partyId, countryCode])
}

model OcpiPartnerTariff {
  id          String   @id @default(uuid())
  countryCode String   @db.VarChar(2) @map("country_code")
  partyId     String   @db.VarChar(3) @map("party_id")
  tariffId    String   @map("tariff_id")
  version     String   @default("2.2.1")
  data        Json
  lastUpdated DateTime @map("last_updated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_partner_tariffs")
  @@unique([countryCode, partyId, tariffId, version])
  @@index([partyId, countryCode])
}

model OcpiPartnerToken {
  id          String   @id @default(uuid())
  countryCode String   @db.VarChar(2) @map("country_code")
  partyId     String   @db.VarChar(3) @map("party_id")
  tokenUid    String   @map("token_uid")
  tokenType   String   @map("token_type")
  version     String   @default("2.2.1")
  data        Json
  lastUpdated DateTime @map("last_updated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_partner_tokens")
  @@unique([countryCode, partyId, tokenUid, tokenType, version])
  @@index([partyId, countryCode])
}

model OcpiToken {
  id          String   @id @default(uuid())
  countryCode String   @db.VarChar(2) @map("country_code")
  partyId     String   @db.VarChar(3) @map("party_id")
  tokenUid    String   @map("token_uid")
  tokenType   String   @map("token_type")
  data        Json
  lastUpdated DateTime @map("last_updated")
  valid       Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_tokens")
  @@unique([countryCode, partyId, tokenUid, tokenType])
  @@index([partyId, countryCode])
}

model OcpiPartnerSession {
  id          String   @id @default(uuid())
  countryCode String   @db.VarChar(2) @map("country_code")
  partyId     String   @db.VarChar(3) @map("party_id")
  sessionId   String   @map("session_id")
  version     String   @default("2.2.1")
  data        Json
  lastUpdated DateTime @map("last_updated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_partner_sessions")
  @@unique([countryCode, partyId, sessionId, version])
  @@index([partyId, countryCode])
}

model OcpiPartnerCdr {
  id          String   @id @default(uuid())
  countryCode String   @db.VarChar(2) @map("country_code")
  partyId     String   @db.VarChar(3) @map("party_id")
  cdrId       String   @map("cdr_id")
  version     String   @default("2.2.1")
  data        Json
  lastUpdated DateTime @map("last_updated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ocpi_partner_cdrs")
  @@unique([countryCode, partyId, cdrId, version])
  @@index([partyId, countryCode])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("email_verification_tokens")
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?

  createdAt DateTime @default(now())

  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
  @@index([expiresAt]) // For cleanup and expiry queries
  @@index([revokedAt]) // For revoked token queries
  @@index([userId, expiresAt]) // Composite for user token validation
  @@index([token, revokedAt, expiresAt]) // Composite for refresh validation
}

model ServiceAccount {
  id         String    @id @default(uuid())
  name       String
  clientId   String    @unique @map("client_id")
  secretHash String    @map("secret_hash")
  secretSalt String    @map("secret_salt")
  scopes     Json?     @map("scopes")
  status     String    @default("ACTIVE")
  lastUsedAt DateTime? @map("last_used_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("service_accounts")
  @@index([status])
}

model AuditLog {
  id           String   @id @default(uuid())
  timestamp    DateTime @default(now())
  actor        String   // User ID or system identifier
  actorName    String?  @map("actor_name") // Cached name for display
  action       String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  resource     String   // Resource type (User, Station, Plan, etc.)
  resourceId   String?  @map("resource_id") // ID of affected resource
  details      Json?    // Additional context
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  status       String   @default("SUCCESS") // SUCCESS, FAILURE
  errorMessage String?  @map("error_message")

  @@map("audit_logs")
  @@index([actor])
  @@index([timestamp])
  @@index([resource])
  @@index([action])
  @@index([status])
}
